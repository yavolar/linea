<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Línea Automática</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#020617" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: dark;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      background: radial-gradient(circle at top, #0f172a, #020617 55%, #000 100%);
      color: #e5e7eb;
    }
    .app {
      width: 100%;
      max-width: 960px;
      padding: 0.9rem 0.9rem 1.2rem;
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.7rem;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .logo-badge {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #022c22;
      font-size: 0.9rem;
    }
    h1 {
      font-size: 1.1rem;
      margin: 0;
    }
    .sub {
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.2rem 0.65rem;
      border-radius: 999px;
      border: 1px solid #1f2937;
      font-size: 0.78rem;
    }
    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
    }
    .pill.off .pill-dot {
      background: #f97316;
    }
    .pill.off {
      border-color: #4b5563;
    }

    .grid-kpi {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 0.6rem;
    }
    @media (max-width: 800px) {
      .grid-kpi { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 520px) {
      .grid-kpi { grid-template-columns: minmax(0, 1fr); }
    }

    .card {
      background: rgba(15,23,42,0.96);
      border-radius: 0.9rem;
      border: 1px solid #1f2937;
      box-shadow: 0 16px 35px rgba(0,0,0,0.55);
      padding: 0.7rem 0.8rem;
    }
    .card-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
      margin-bottom: 0.3rem;
    }
    .kpi-value {
      font-size: 1.35rem;
      font-weight: 600;
    }
    .kpi-unit {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-left: 0.25rem;
    }
    .kpi-trend {
      margin-top: 0.25rem;
      font-size: 0.8rem;
      color: #22c55e;
    }

    .row-main {
      display: grid;
      grid-template-columns: 2.1fr 1.4fr;
      gap: 0.7rem;
      align-items: stretch;
    }
    @media (max-width: 720px) {
      .row-main {
        grid-template-columns: minmax(0,1fr);
      }
    }

    canvas {
      width: 100%;
      height: 200px;
      border-radius: 0.85rem;
      background: #020617;
      border: 1px solid #111827;
      display: block;
    }

    .table {
      margin-top: 0.3rem;
      border-radius: 0.8rem;
      border: 1px solid #111827;
      overflow: hidden;
      font-size: 0.78rem;
    }
    .table-header, .table-row {
      display: grid;
      grid-template-columns: 1.1fr 0.8fr 0.8fr 0.8fr;
      padding: 0.35rem 0.55rem;
      gap: 0.4rem;
    }
    .table-header {
      background: #020617;
      color: #9ca3af;
      font-size: 0.76rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .table-row:nth-child(odd) {
      background: rgba(15,23,42,0.92);
    }
    .table-row:nth-child(even) {
      background: rgba(15,23,42,0.85);
    }

    footer {
      margin-top: 0.2rem;
      font-size: 0.7rem;
      color: #6b7280;
      text-align: right;
    }

    .btn {
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #0f172a;
      color: #e5e7eb;
      font-size: 0.78rem;
      cursor: pointer;
    }
    .btn:active { transform: scale(0.97); }
  </style>
</head>
<body>
  <main class="app">
    <header>
      <div class="logo">
        <div class="logo-badge">LA</div>
        <div>
          <h1>Dashboard Línea Automática</h1>
          <div class="sub">Demo estática desde GitHub Pages (producción simulada)</div>
        </div>
      </div>
      <div>
        <div id="pillEstado" class="pill off">
          <span class="pill-dot"></span>
          <span id="pillTexto">Offline · datos de prueba</span>
        </div>
        <div style="margin-top:0.3rem; text-align:right;">
          <button id="btnRefrescar" class="btn">Refrescar datos demo</button>
        </div>
      </div>
    </header>

    <section class="grid-kpi" id="kpiPanel">
      <!-- KPIs se rellenan por JS -->
    </section>

    <section class="row-main">
      <div class="card">
        <div class="card-title">Producción últimas 12 horas (simulada)</div>
        <canvas id="grafico"></canvas>
      </div>
      <div class="card">
        <div class="card-title">Turnos recientes</div>
        <div class="table" id="tablaTurnos"></div>
      </div>
    </section>

    <footer>
      PWA hospedada en GitHub Pages · Lista para conectar a <code>http://linea.local/api/...</code> cuando tengamos el LILYGO.
    </footer>
  </main>

  <script>
    // Registro del service worker para PWA
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .catch(err => console.error("Error SW", err));
    }

    const pillEstado = document.getElementById("pillEstado");
    const pillTexto = document.getElementById("pillTexto");
    const btnRefrescar = document.getElementById("btnRefrescar");
    const canvas = document.getElementById("grafico");
    const ctx = canvas.getContext("2d");
    const kpiPanel = document.getElementById("kpiPanel");
    const tablaTurnos = document.getElementById("tablaTurnos");

    function generarDemo() {
      // Demo de datos como si vinieran del PLC/LILYGO
      const baseOEE = 82 + Math.random() * 6;
      const datos = {
        oee: baseOEE.toFixed(1),
        rendimiento: (93 + Math.random() * 4).toFixed(1),
        disponibilidad: (96 + Math.random() * 2).toFixed(1),
        calidad: (98 + Math.random() * 1.5).toFixed(1),
        seriesHoras: [],
        turnos: []
      };

      const ahora = new Date();
      for (let i = 11; i >= 0; i--) {
        const f = new Date(ahora);
        f.setHours(ahora.getHours() - i);
        const hh = String(f.getHours()).padStart(2, "0") + ":00";
        const prod = 18 + Math.round(Math.random() * 10); // bultos/hora simulados
        datos.seriesHoras.push({ label: hh, valor: prod });
      }

      for (let i = 0; i < 4; i++) {
        const f = new Date(ahora);
        f.setDate(f.getDate() - i);
        const dia = String(f.getDate()).padStart(2, "0") + "/" + String(f.getMonth()+1).padStart(2,"0");
        datos.turnos.push({
          fecha: dia,
          prod: 120 + Math.round(Math.random()*40),
          oee: (80 + Math.random()*10).toFixed(1),
          logro: (90 + Math.random()*12).toFixed(0) + "%"
        });
      }

      return datos;
    }

    function pintarKPIs(datos) {
      kpiPanel.innerHTML = "";
      const items = [
        { label: "OEE", valor: datos.oee + "%", tend: "+1.2% vs ayer" },
        { label: "Rendimiento", valor: datos.rendimiento + "%", tend: "+0.8% vs media" },
        { label: "Disponibilidad", valor: datos.disponibilidad + "%", tend: "OK · sin paradas largas" },
        { label: "Calidad", valor: datos.calidad + "%", tend: "< 2% rechazos" }
      ];
      items.forEach(k => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="card-title">${k.label}</div>
          <div><span class="kpi-value">${k.valor}</span></div>
          <div class="kpi-trend">${k.tend}</div>
        `;
        kpiPanel.appendChild(div);
      });
    }

    function redimensionarCanvas() {
      const rect = canvas.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;
      canvas.width = rect.width * ratio;
      canvas.height = 210 * ratio;
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
    }

    function pintarGrafico(datos) {
      redimensionarCanvas();
      const w = canvas.width / (window.devicePixelRatio || 1);
      const h = canvas.height / (window.devicePixelRatio || 1);

      ctx.clearRect(0, 0, w, h);

      const padding = { top: 18, right: 18, bottom: 26, left: 30 };
      const cw = w - padding.left - padding.right;
      const ch = h - padding.top - padding.bottom;

      const arr = datos.seriesHoras;
      const maxVal = Math.max(...arr.map(p => p.valor)) * 1.25;

      // Fondo
      ctx.fillStyle = "#020617";
      ctx.fillRect(0, 0, w, h);

      // Líneas horizontales
      ctx.strokeStyle = "#111827";
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = padding.top + (ch * i) / 4;
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(padding.left + cw, y);
        ctx.stroke();
      }

      // Eje X labels
      ctx.fillStyle = "#9ca3af";
      ctx.font = "10px system-ui";
      ctx.textAlign = "center";
      arr.forEach((p, i) => {
        const x = padding.left + (cw / (arr.length - 1)) * i;
        ctx.fillText(p.label, x, padding.top + ch + 18);
      });

      // Puntos y línea
      const pts = arr.map((p, i) => {
        const x = padding.left + (cw / (arr.length - 1)) * i;
        const y = padding.top + ch - (p.valor / maxVal) * ch;
        return { x, y, valor: p.valor };
      });

      ctx.save();
      ctx.beginPath();
      ctx.strokeStyle = "#22c55e";
      ctx.lineWidth = 2;
      pts.forEach((p, i) => {
        if (i === 0) ctx.moveTo(p.x, p.y);
        else ctx.lineTo(p.x, p.y);
      });
      ctx.stroke();
      ctx.restore();

      pts.forEach(p => {
        ctx.beginPath();
        ctx.fillStyle = "#22c55e";
        ctx.arc(p.x, p.y, 3, 0, Math.PI*2);
        ctx.fill();
      });
    }

    function pintarTabla(datos) {
      const t = document.createElement("div");
      t.innerHTML = "";
      t.innerHTML = `
        <div class="table-header">
          <div>Fecha</div><div>Prod (bultos)</div><div>OEE</div><div>Logro</div>
        </div>
      `;
      datos.turnos.forEach(row => {
        const r = document.createElement("div");
        r.className = "table-row";
        r.innerHTML = `
          <div>${row.fecha}</div>
          <div>${row.prod}</div>
          <div>${row.oee}%</div>
          <div>${row.logro}</div>
        `;
        t.appendChild(r);
      });
      tablaTurnos.innerHTML = "";
      tablaTurnos.appendChild(t);
    }

    function refrescarDemo() {
      const datos = generarDemo();
      pintarKPIs(datos);
      pintarGrafico(datos);
      pintarTabla(datos);
    }

    window.addEventListener("resize", () => {
      const datos = generarDemo();
      pintarGrafico(datos);
    });

    btnRefrescar.addEventListener("click", () => {
      refrescarDemo();
    });

    // Estado pill (de momento siempre demo offline)
    pillEstado.classList.add("off");
    pillTexto.textContent = "Demo offline · sin conexión a línea";

    // Primera carga
    refrescarDemo();
  </script>
</body>
</html>
